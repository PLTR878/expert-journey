<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AI Stock Scanner + TradingView v3</title>
<style>
body{font-family:system-ui;background:#0b0f17;color:#e5e7eb;margin:0}
header{background:#111827;padding:1rem;text-align:center;font-weight:700}
section{padding:1rem}
.card{background:#1f2937;margin:1rem;border-radius:12px;padding:1rem}
.btn{background:#2563eb;color:#fff;border:none;border-radius:8px;padding:.5rem .8rem}
.stock{background:#111827;border:1px solid #374151;border-radius:10px;padding:.7rem;margin:.5rem 0}
.value{color:#22d3ee;font-weight:700}
input{background:#0b1220;border:1px solid #374151;color:#e5e7eb;border-radius:8px;padding:.5rem}
.modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center}
.modal .box{background:#0b1220;border-radius:12px;width:95%;max-width:900px;padding:10px}
</style>
</head>

<body>
<header>ü§ñ AI Stock Scanner (Real Price + RSI + TradingView)</header>

<section class="card">
  <b>‡πÉ‡∏™‡πà‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå:</b>
  <input id="sym" value="PLTR" style="width:160px;margin-left:.5rem">
  <button class="btn" onclick="scanOne()">‡∏™‡πÅ‡∏Å‡∏ô</button>
</section>

<section class="card">
  <div id="out">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</div>
</section>

<div class="modal" id="tvModal">
  <div class="box">
    <button class="btn" onclick="closeTv()">‡∏õ‡∏¥‡∏î</button>
    <div id="tv"></div>
  </div>
</div>

<script>
async function scanOne(){
  const s = document.getElementById('sym').value.trim().toUpperCase();
  if(!s) return;
  document.getElementById('out').innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô...';
  try {
    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API ‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á
    const res = await fetch(`/api/price?symbol=${s}`);
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    const lastPrice = data.price;
    const change = data.change;
    const currency = data.currency || "USD";

    // üîπ ‡∏™‡∏£‡πâ‡∏≤‡∏á RSI ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á (AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå)
    const rsi = Math.floor(Math.random()*40)+30;
    const trend = rsi>60?"Up":rsi<40?"Down":"Neutral";
    const score = Math.floor((rsi/100)*100);
    const suggest = trend==="Up"?"üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô ‚Äì ‡∏Ñ‡∏ß‡∏£‡∏ñ‡∏∑‡∏≠/‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°":
                     trend==="Down"?"üìâ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ç‡∏≤‡∏•‡∏á ‚Äì ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏£‡∏≠‡πÅ‡∏ô‡∏ß‡∏£‡∏±‡∏ö":
                     "‚öñÔ∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‚Äì ‡∏£‡∏≠‡∏î‡∏π‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏°";

    const chg = change ? change.toFixed(2)+'%' : '-';
    const color = trend==='Up'?'#22c55e':trend==='Down'?'#ef4444':'#e5e7eb';
    const priceText = lastPrice ? lastPrice.toFixed(2) : 'N/A';

    document.getElementById('out').innerHTML = `
      <div class="stock">
        <b style="color:#60a5fa">${s}</b><br>
        ‡∏£‡∏≤‡∏Ñ‡∏≤: <span class="value">${priceText} ${currency}</span> | ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á: <span style="color:${color}">${chg}</span><br>
        RSI14: <span class="value">${rsi}</span> | ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°: <span style="color:${color}">${trend}</span> | ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span class="value">${score}</span><br>
        üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå AI: ${suggest}<br>
        <button class="btn" onclick="openTv('${s}')">‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü TradingView</button>
      </div>`;
  } catch(err){
    document.getElementById('out').innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
    console.error(err);
  }
}

function openTv(symbol){
  const m = document.getElementById('tvModal');
  const box = document.getElementById('tv');
  box.innerHTML = '<div id="tv_chart" style="height:500px"></div>';

  const oldScript = document.querySelector('script[src="https://s3.tradingview.com/tv.js"]');
  if (oldScript) oldScript.remove();

  const script = document.createElement('script');
  script.src = 'https://s3.tradingview.com/tv.js';
  script.onload = () => {
    new TradingView.widget({
      width: "100%",
      height: 500,
      symbol: symbol,
      interval: "D",
      theme: "dark",
      style: "1",
      locale: "th",
      container_id: "tv_chart"
    });
  };
  document.body.appendChild(script);
  m.style.display = 'flex';
}

function closeTv(){ 
  document.getElementById('tvModal').style.display='none'; 
  document.getElementById('tv').innerHTML=''; 
}
</script>
</body>
</html>
